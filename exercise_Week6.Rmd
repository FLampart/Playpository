---
title: "Homework Week 6:"
author: "Franziska Lampart"
date: "October 31, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, echo=FALSE}
# Code copied from the exercise only showed when modiefied
library("limma")
nGenes <- 10000                   # number of "features"
nSamples <- 6                     # number of samples (split equal in 2 groups)
pDiff <- .1                       # percent of genes "differential 
grp <- rep(0:1,each=nSamples/2)   # dummy variable for exp. group
trueFC <- 2                       # log-fold-change of truly DE

d0 <- 1
s0 <- 0.8
sd <- s0*sqrt(d0/rchisq(nGenes,df=d0))  # dist'n of s.d.

y <- matrix(rnorm(nGenes*nSamples,sd=sd),
            nr=nGenes,nc=nSamples)

indD <- 1:floor(pDiff*nGenes)
diff <- sample(c(-1,1),max(indD),replace=TRUE)*trueFC
y[indD,grp==1] <- y[indD,grp==1] + diff
```

#### Question 2

The first 1000 "Genes"" have an expression change of either -2 or +2 in the second half of the samples (group 2).
```{r}
barplot(y[1, 1:6], main = "Variance +/-2")
barplot(y[1001, 1:6], main = "No Variance")
```

#### Question 3

First column (intercept): y-axis intercept

Second column (grp): Group membership

```{r, echo = FALSE}
design <- model.matrix(~grp)
fit <- lmFit(y,design)
fit <- eBayes(fit)

print(design)
```

#### Question 4.

```{r}
classicalt <- c()
classicalp <- c() #needet later in Question 6
for (i in c(1:nGenes)){
  var <- t.test(y[i,1:3], y[i,4:6], var.equal = TRUE)
  classicalt[i] <- var$statistic
  classicalp[i] <- var$p.value
}
```
#### Question 5.
```{r, echo = FALSE}
cols <- rep("black",nrow(y))
cols[indD] <- "blue"

par(mfrow=c(2,1))
plot( fit$t[,2], col=cols, ylim=c(-10,10), pch=".", main="Moderated-t" )
plot( fit$coef[,2], col=cols, ylim=c(-6,6), pch=".", main="log FC" )
plot( classicalt, col=cols, ylim=c(-10,10), pch=".", main="Classical-t" )
```

The moderated t-test and the classical t-test look very similar under this conditions, with a big dispersion of values in the first 1000 samples and a lower dispersion for the rest of the samples. In the log FC we can see a separation in two to groups (-2 and +2).

#### Question 6.
```{r}
# Ratio of false negatives:
Clp_fneg <- sum(classicalp[1:length(diff)] > 0.05)
Fp_fneg <- sum(fit$p.value[1:length(diff), 2] > 0.05)
FC_fneg <- 1000-(sum(fit$coefficients[1:length(diff),2] > 2) + 
                   sum(fit$coefficients[1:length(diff),2] < -2))
ratio_fneg <- c(Clp_fneg, Fp_fneg, FC_fneg)/length(diff)
# Ratio of false positives:
Clp_fpos <- sum(classicalp[(length(diff)+1):nGenes] < 0.05)
Fp_fpos <- sum(fit$p.value[(length(diff)+1):nGenes, 2] < 0.05)
FC_fpos <- (sum(fit$coefficients[1:length(diff),2] > 2) + 
                   sum(fit$coefficients[1:length(diff),2] < -2))
ratio_fpos <- c(Clp_fpos, Fp_fpos, FC_fpos)/(nGenes-length(diff))

barplot(c(ratio_fneg, ratio_fpos), main = "False discovery rate",
        names.arg=c("Fneg cls-t", "Fneg mod-t", "Fneg FC", "Fpos cls-t", "Fpos mod-t", "Fpos FC"))
```

All methods have a higher false negative rate than false positive. Surprisingly the FC has the lowest false negative rate, however in context of false positive it performs the worst.

#### Question 7
```{r, echo = FALSE}
nGenes <- 1000
sd <- s0*sqrt(d0/rchisq(nGenes,df=d0))  # dist'n of s.d.

y <- matrix(rnorm(nGenes*nSamples,sd=sd),
            nr=nGenes,nc=nSamples)

indD <- 1:floor(pDiff*nGenes)
diff <- sample(c(-1,1),max(indD),replace=TRUE)*trueFC
y[indD,grp==1] <- y[indD,grp==1] + diff

design <- model.matrix(~grp)
fit <- lmFit(y,design)
fit <- eBayes(fit)

classicalp <- c()
for (i in c(1:nGenes)){
  var <- t.test(y[i,1:3], y[i,4:6], var.equal = TRUE)
  classicalp[i] <- var$p.value
}

# Ratio of false negatives:
Clp_fneg <- sum(classicalp[1:length(diff)] > 0.05)
Fp_fneg <- sum(fit$p.value[1:length(diff), 2] > 0.05)
FC_fneg <- length(diff)-(sum(fit$coefficients[1:length(diff),2] > 2) + 
                   sum(fit$coefficients[1:length(diff),2] < -2))
ratio_fneg <- c(Clp_fneg, Fp_fneg, FC_fneg)/length(diff)
# Ratio of false positives:
Clp_fpos <- sum(classicalp[(length(diff)+1):nGenes] < 0.05)
Fp_fpos <- sum(fit$p.value[(length(diff)+1):nGenes, 2] < 0.05)
FC_fpos <- (sum(fit$coefficients[1:length(diff),2] > 2) + 
                   sum(fit$coefficients[1:length(diff),2] < -2))
ratio_fpos <- c(Clp_fpos, Fp_fpos, FC_fpos)/(nGenes-length(diff))

barplot(c(ratio_fneg, ratio_fpos), main = "False discovery rate",
        names.arg=c("Fneg cls-t", "Fneg mod-t", "Fneg FC", "Fpos cls-t", "Fpos mod-t", "Fpos FC"))
```

If the number of genes are reduced FC performs still the best in context of false negative but hast the highest false positive rate. The same is true when we decrease the number of samples to 4. However here the overall false discovery rates increases.

```{r, echo = FALSE}
nGenes <- 10000
nSamples <- 4
grp <- rep(0:1,each=nSamples/2)

sd <- s0*sqrt(d0/rchisq(nGenes,df=d0))  # dist'n of s.d.

y <- matrix(rnorm(nGenes*nSamples,sd=sd),
            nr=nGenes,nc=nSamples)

indD <- 1:floor(pDiff*nGenes)
diff <- sample(c(-1,1),max(indD),replace=TRUE)*trueFC
y[indD,grp==1] <- y[indD,grp==1] + diff

design <- model.matrix(~grp)
fit <- lmFit(y,design)
fit <- eBayes(fit)
classicalp <- c()

for (i in c(1:nGenes)){
  var <- t.test(y[i,1:2], y[i,3:4], var.equal = TRUE)
  classicalp[i] <- var$p.value
}

# Ratio of false negatives:
Clp_fneg <- sum(classicalp[1:length(diff)] > 0.05)
Fp_fneg <- sum(fit$p.value[1:length(diff), 2] > 0.05)
FC_fneg <- length(diff)-(sum(fit$coefficients[1:length(diff),2] > 2) + 
                   sum(fit$coefficients[1:length(diff),2] < -2))
ratio_fneg <- c(Clp_fneg, Fp_fneg, FC_fneg)/length(diff)
# Ratio of false positives:
Clp_fpos <- sum(classicalp[(length(diff)+1):nGenes] < 0.05)
Fp_fpos <- sum(fit$p.value[(length(diff)+1):nGenes, 2] < 0.05)
FC_fpos <- (sum(fit$coefficients[1:length(diff),2] > 2) + 
                   sum(fit$coefficients[1:length(diff),2] < -2))
ratio_fpos <- c(Clp_fpos, Fp_fpos, FC_fpos)/(nGenes-length(diff))

barplot(c(ratio_fneg, ratio_fpos), main = "False discovery rate",
        names.arg=c("Fneg cls-t", "Fneg mod-t", "Fneg FC", "Fpos cls-t", "Fpos mod-t", "Fpos FC"))
```

